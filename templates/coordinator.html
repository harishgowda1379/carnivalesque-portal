<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Coordinator - Carnivalesque 26</title>
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Raleway:wght@200;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-purple: #0dba64;
            --neon-blue: #10ed1f;
            --neon-gold: #ffcc00;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Raleway', sans-serif;
            background: #050505;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            background-image: radial-gradient(circle at 50% 100%, rgba(186, 104, 255, 0.1), transparent);
        }

        /* Starfield Background */
        .stars-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.5; animation: twinkle var(--duration) infinite ease-in-out; }
        @keyframes twinkle { 0%, 100% { opacity: 0.2; transform: scale(1); } 50% { opacity: 1; transform: scale(1.4); } }

        header {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            text-align: center;
            font-family: 'Syncopate', sans-serif;
            letter-spacing: 8px;
            text-transform: uppercase;
            font-size: 18px;
            color: #fff;
            text-shadow: 0 0 15px var(--neon-purple);
            position: sticky; top: 0; z-index: 100;
            position: relative;
        }

        .back-to-login-btn {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-family: 'Raleway', sans-serif;
            font-size: 12px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .back-to-login-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
            color: #fff;
            box-shadow: 0 0 20px rgba(255,255,255,0.1);
        }

        @media (max-width: 768px) {
            header {
                padding-left: 100px;
                text-align: center;
            }
            .back-to-login-btn {
                padding: 6px 12px;
                font-size: 10px;
                left: 10px;
            }
        }

        .container {
            max-width: 1100px;
            margin: 40px auto;
            padding: 0 20px;
            position: relative;
            z-index: 10;
        }

        .card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 4px;
            border: 1px solid var(--glass-border);
            margin-bottom: 30px;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h3 {
            font-family: 'Syncopate', sans-serif;
            font-size: 14px;
            letter-spacing: 4px;
            text-transform: uppercase;
            margin-bottom: 30px;
            color: var(--neon-blue);
        }

        /* Events Grid */
        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .event-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--glass-border);
            padding: 30px;
            cursor: pointer;
            transition: 0.4s;
            text-align: center;
            position: relative;
        }

        .event-card:hover {
            border-color: var(--neon-purple);
            background: rgba(186, 104, 255, 0.05);
            box-shadow: 0 0 30px rgba(186, 104, 255, 0.2);
            transform: scale(1.02);
        }

        .event-name {
            font-family: 'Syncopate', sans-serif;
            font-size: 12px;
            letter-spacing: 2px;
            margin-top: 15px;
        }

        .event-icon { font-size: 40px; opacity: 0.7; filter: drop-shadow(0 0 10px var(--neon-blue)); }

        /* Modal - Glassmorphism style */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 1000;
            justify-content: center; align-items: center; backdrop-filter: blur(10px);
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #0a0a0a; padding: 50px; border: 1px solid var(--neon-purple);
            max-width: 450px; width: 90%; text-align: center;
        }

        input, select {
            width: 100%; padding: 18px; background: rgba(0,0,0,0.5);
            border: 1px solid var(--glass-border); color: #fff;
            font-family: 'Raleway', sans-serif; letter-spacing: 2px; margin-bottom: 20px;
        }
        input:focus, select:focus { outline: none; border-color: var(--neon-purple); box-shadow: 0 0 15px var(--neon-purple); }

        button {
            width: 100%; padding: 18px; font-family: 'Syncopate', sans-serif;
            font-size: 10px; letter-spacing: 3px; text-transform: uppercase;
            background: transparent; border: 1px solid var(--neon-purple); color: var(--neon-purple);
            cursor: pointer; transition: 0.4s; margin-bottom: 10px;
        }
        button:hover:not(:disabled) { background: var(--neon-purple); color: #000; box-shadow: 0 0 30px var(--neon-purple); }

        .btn-secondary { border-color: rgba(255,255,255,0.3); color: rgba(255,255,255,0.5); }

        /* Team & List Styling */
        .badge {
            display: inline-block; padding: 6px 15px; border: 1px solid var(--neon-blue);
            color: var(--neon-blue); font-size: 10px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px;
        }

        .team-box {
            background: rgba(255,255,255,0.02); border-left: 3px solid var(--neon-purple);
            padding: 20px; margin-bottom: 15px;
        }
        .team-box strong { font-family: 'Syncopate', sans-serif; font-size: 10px; color: var(--neon-purple); }
        .team-info {
            margin-top: 8px;
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .team-info span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .team-info span::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--neon-blue);
            border-radius: 50%;
        }
        .team-box ul { list-style: none; margin-top: 10px; padding-left: 5px; }
        .team-box li { font-size: 14px; color: rgba(255,255,255,0.7); padding: 4px 0; }

        /* Winner Section */
        .winner-toggle {
            display: flex; justify-content: space-between; padding: 20px;
            border: 1px dashed var(--glass-border); cursor: pointer; transition: 0.3s;
        }
        .winner-toggle:hover { background: rgba(255,255,255,0.05); }

        .winner-content { max-height: 0; overflow: hidden; transition: 0.5s ease-in-out; }
        .winner-content.active { max-height: 1200px; padding-top: 30px; }

        .winner-box strong { color: var(--neon-gold); font-size: 12px; text-transform: uppercase; display: block; margin-bottom: 10px; }

        .current-event {
            font-family: 'Syncopate', sans-serif; padding: 20px; border: 1px solid var(--neon-blue);
            color: var(--neon-blue); text-align: center; margin-bottom: 30px; letter-spacing: 3px;
        }

        .success, .error { padding: 20px; margin-top: 20px; font-size: 12px; letter-spacing: 1px; display: none; }
        .success { border: 1px solid #00ffcc; color: #00ffcc; background: rgba(0, 255, 204, 0.05); }
        .error { border: 1px solid #ff4b4b; color: #ff4b4b; background: rgba(255, 75, 75, 0.05); }

        .hidden { display: none; }
    </style>
</head>

<body>

<div class="stars-container" id="stars"></div>

<header>
        <a href="/login" class="back-to-login-btn">‚Üê Back to Login</a>
        Coordinator Node
    </header>

<div class="container">

    <div class="card" id="eventsCard">
        <h3>Active Event Grid</h3>
        <div class="events-grid" id="eventsGrid">
            <div style="text-align: center; width: 100%; opacity: 0.5;">Establishing Link to Database...</div>
        </div>
    </div>

    <div class="modal" id="codeModal">
        <div class="modal-content">
            <h3 id="modalEventName" style="font-size: 12px;">Security Verification</h3>
            <div class="form-group">
                <input type="text" id="eventCode" placeholder="ACCESS_CODE" maxlength="10">
            </div>
            <button onclick="verifyCode()" id="verifyBtn">Verify Link</button>
            <button class="btn-secondary" onclick="closeModal()">Abort</button>
            <div class="error" id="codeError"></div>
        </div>
    </div>

    <div class="card hidden" id="eventDetailsCard">
        <div class="current-event" id="currentEventName"></div>

        <div class="badge">Live Unit Reports</div>
        <div id="teamList">
            <div style="padding: 20px; opacity: 0.5;">No telemetry data received...</div>
        </div>

        <button onclick="startEvent()" id="startBtn" style="border-color: var(--neon-blue); color: var(--neon-blue); margin-top: 30px;">
            Mark as event start
        </button>
        <div class="success" id="startSuccess"></div>
        <div class="error" id="startError"></div>
    </div>

    <div class="card hidden" id="winnersCard">
        <h3>Ranking & Results</h3>
        <div class="winner-section">
            <div class="winner-toggle" id="winnerToggle" onclick="toggleWinners()">
                <strong>üèÜ Assign Winners</strong>
                <span>‚ñº</span>
            </div>
            <div class="winner-content" id="winnerContent">
                <div class="winner-box">
                    <strong>ü•á 1st Place (1st)</strong>
                    <select id="firstPlace"></select>
                </div>
                <div class="winner-box">
                    <strong>ü•à 2nd Place (2nd)</strong>
                    <select id="secondPlace"></select>
                </div>
                <div class="winner-box">
                    <strong>ü•â 3rd Place (3rd)</strong>
                    <select id="thirdPlace"></select>
                </div>
                <button onclick="endEvent()" id="endBtn" style="border-color: var(--neon-gold); color: var(--neon-gold);">
                    Finalize Results & Transmit
                </button>
                <div class="success" id="endSuccess"></div>
                <div class="error" id="endError"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Starfield Generator
    const starsContainer = document.getElementById('stars');
    for (let i = 0; i < 120; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        const size = Math.random() * 2 + 'px';
        star.style.width = size; star.style.height = size;
        star.style.top = Math.random() * 100 + '%';
        star.style.left = Math.random() * 100 + '%';
        star.style.setProperty('--duration', Math.random() * 3 + 2 + 's');
        starsContainer.appendChild(star);
    }

    /* LOGIC REMAINS IDENTICAL TO YOURS */
    let allEvents = [];
    let currentEvent = null;
    let reportedTeams = [];
    let eventStarted = false;
    let selectedWinners = { first: null, second: null, third: null };

    fetch("/get_events")
        .then(res => res.json())
        .then(events => {
            allEvents = events;
            renderEvents();
        }).catch(() => {
            document.getElementById("eventsGrid").innerHTML = '<div style="color:red">Link Error</div>';
        });

    function renderEvents() {
        const grid = document.getElementById("eventsGrid");
        grid.innerHTML = "";
        allEvents.forEach(event => {
            const card = document.createElement("div");
            card.className = "event-card";
            card.onclick = () => openCodeModal(event);
            card.innerHTML = `<div class="event-icon"></div><div class="event-name">${event}</div>`;
            grid.appendChild(card);
        });
    }

    function openCodeModal(event) {
        currentEvent = event;
        document.getElementById("modalEventName").textContent = `ACCESS: ${event}`;
        document.getElementById("codeModal").classList.add("active");
    }

    function closeModal() {
        document.getElementById("codeModal").classList.remove("active");
        currentEvent = null;
        // Stop auto-refresh when closing modal
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }

    function verifyCode() {
        const code = document.getElementById("eventCode").value.trim();
        const verifyBtn = document.getElementById("verifyBtn");
        verifyBtn.innerText = "LINKING...";

        fetch("/verify_event_code", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ event: currentEvent, code: code })
        })
        .then(res => res.json())
        .then(data => {
            verifyBtn.innerText = "VERIFY LINK";
            if (data.success) {
                document.getElementById("codeModal").classList.remove("active");
                loadEventDetails();
            } else {
                document.getElementById("codeError").style.display = "block";
                document.getElementById("codeError").textContent = "Access Denied";
            }
        });
    }

    let autoRefreshInterval = null;

    function loadEventDetails() {
        document.getElementById("eventsCard").classList.add("hidden");
        document.getElementById("eventDetailsCard").classList.remove("hidden");
        document.getElementById("currentEventName").textContent = `OPERATING: ${currentEvent}`;

        // Initial load
        fetchAndUpdateTeams();
        
        // Start auto-refresh every 2 seconds
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        autoRefreshInterval = setInterval(fetchAndUpdateTeams, 2000);
    }

    function fetchAndUpdateTeams() {
        fetch("/get_reported_teams", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ event: currentEvent })
        })
        .then(res => res.json())
        .then(data => {
            reportedTeams = data.teams || data || [];
            eventStarted = data.event_started || false;
            renderTeams();
            updateWinnerDropdowns();
            if (eventStarted) document.getElementById("winnersCard").classList.remove("hidden");
        })
        .catch(err => console.error("Auto-refresh error:", err));
    }

    function renderTeams() {
        const container = document.getElementById("teamList");
        container.innerHTML = "";
        
        if (reportedTeams.length === 0) {
            container.innerHTML = '<div style="padding: 20px; opacity: 0.5;">No telemetry data received...</div>';
            return;
        }
        
        reportedTeams.forEach(t => {
            const teamBox = document.createElement("div");
            teamBox.className = "team-box";
            
            const collegeInfo = t.college ? `<span>${t.college}</span>` : '';
            const contactInfo = t.contact ? `<span style="cursor: pointer; color: var(--neon-blue); text-decoration: underline;" onclick="promptCall('${t.contact}')">üìû ${t.contact}</span>` : '';
            const infoSection = (collegeInfo || contactInfo) ? 
                `<div class="team-info">${collegeInfo}${contactInfo}</div>` : '';
            
            teamBox.innerHTML = `
                <strong>UNIT ${t.reg_no}</strong>
                ${infoSection}
                <ul>${t.team.map((m, i) => `<li>${i === 0 ? '‚óà ' + m : '‚óã ' + m}</li>`).join('')}</ul>
            `;
            container.appendChild(teamBox);
        });
    }

    function promptCall(phone) {
        if (confirm(`Call ${phone}?`)) {
            window.location.href = `tel:${phone}`;
        }
    }

    function updateWinnerDropdowns() {
        const ids = ["firstPlace", "secondPlace", "thirdPlace"];
        const keys = ["first", "second", "third"];
        ids.forEach((id, idx) => {
            const select = document.getElementById(id);
            select.innerHTML = `<option value="">SELECT POSITION</option>`;
            reportedTeams.forEach(t => {
                const isSelectedElsewhere = (selectedWinners.first === t.reg_no && keys[idx] !== "first") ||
                                           (selectedWinners.second === t.reg_no && keys[idx] !== "second") ||
                                           (selectedWinners.third === t.reg_no && keys[idx] !== "third");
                if (!isSelectedElsewhere) {
                    const opt = document.createElement("option");
                    opt.value = t.reg_no;
                    opt.textContent = `${t.reg_no} | ${t.team[0]}`;
                    if (selectedWinners[keys[idx]] === t.reg_no) opt.selected = true;
                    select.appendChild(opt);
                }
            });
            select.onchange = () => { selectedWinners[keys[idx]] = select.value || null; updateWinnerDropdowns(); };
        });
    }

    function startEvent() {
        fetch("/start_event", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ event: currentEvent })
        }).then(() => {
            eventStarted = true;
            document.getElementById("startSuccess").style.display = "block";
            document.getElementById("startSuccess").textContent = "SEQUENCE INITIALIZED";
            document.getElementById("winnersCard").classList.remove("hidden");
        });
    }

    function toggleWinners() {
        document.getElementById("winnerToggle").classList.toggle("active");
        document.getElementById("winnerContent").classList.toggle("active");
    }

    function endEvent() {
        const winners = {};
        if (selectedWinners.first) winners[selectedWinners.first] = 1;
        if (selectedWinners.second) winners[selectedWinners.second] = 2;
        if (selectedWinners.third) winners[selectedWinners.third] = 3;

        fetch("/end_event", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ winners: winners })
        }).then(res => res.json()).then(data => {
            if (data.error) {
                document.getElementById("endError").style.display = "block";
                document.getElementById("endError").textContent = data.error;
            } else {
                document.getElementById("endSuccess").style.display = "block";
                document.getElementById("endSuccess").textContent = "DATA UPLOADED TO CLOUD";
            }
        });
    }
</script>
</body>
</html>